#!/bin/bash
set -e # Exit immediately if errors occur

# --- Configuration ---
WORKSPACE_DIR="/workspace"
COMFY_REPO="https://github.com/comfyanonymous/ComfyUI.git"
MANAGER_REPO="https://github.com/ltdrdata/ComfyUI-Manager.git"

# Define Paths
COMFY_BASE="${WORKSPACE_DIR}/ComfyUI"

# --- Fix VS Code Git Errors (Standard Fix) ---
unset GIT_ASKPASS
unset SSH_ASKPASS
git config --global --unset credential.helper || true
git config --global credential.helper store

# Ensure HF_TOKEN is grabbed from environment (for authenticated downloads if needed)
if [ -z "$HF_TOKEN" ] && [ -r /proc/1/environ ]; then
    PID_HF_TOKEN=$(tr '\0' '\n' < /proc/1/environ | grep '^HF_Token=' | head -n 1 | cut -d '=' -f2-)
    [ ! -z "$PID_HF_TOKEN" ] && export HF_TOKEN="$PID_HF_TOKEN"
fi

# Download Helper (Uses aria2c)
download_file() {
    local url="$1"
    local dest_dir="$2"
    local filename="$3"
    
    mkdir -p "$dest_dir"
    local dest_path="${dest_dir}/${filename}"

    if [ -f "$dest_path" ]; then
        echo "  ‚úì ${filename} already exists."
        return
    fi

    echo "  ‚¨áÔ∏è Downloading ${filename}..."
    if [ ! -z "$HF_TOKEN" ]; then
        aria2c -x 16 -s 16 -k 1M --header="Authorization: Bearer $HF_TOKEN" -d "$dest_dir" -o "$filename" "$url"
    else
        aria2c -x 16 -s 16 -k 1M -d "$dest_dir" -o "$filename" "$url"
    fi
}

echo "üé• Setting up Wan 2.2 (5B TI2V - Optimized for RTX 4090)"
echo "=========================================================="
echo "‚ú® Features: 720p @ 24fps, Text-to-Video & Image-to-Video"
echo "‚ú® Speed: Under 9 minutes for 5-second video on RTX 4090"
echo "=========================================================="

# 1. Install System Tools
echo "üõ†Ô∏è Updating system tools..."
apt-get update && apt-get install -y git wget aria2 libgl1-mesa-glx > /dev/null 2>&1

# 1.5 ‚úÖ FIX: Upgrade PyTorch to fix compatibility issues
echo "üîÑ Upgrading PyTorch and dependencies..."
pip install --upgrade torch torchvision torchaudio xformers --index-url https://download.pytorch.org/whl/cu121

# 1.6 ‚úÖ FIX: Set CUDA library paths so PyTorch can find CUDA runtime
echo "üîß Configuring CUDA library paths..."
echo 'export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH

# 2. Setup ComfyUI
echo "üõãÔ∏è Cloning ComfyUI..."
if [ ! -d "$COMFY_BASE" ]; then
    git clone --depth 1 "$COMFY_REPO" "$COMFY_BASE"
fi

# Install Manager
if [ ! -d "${COMFY_BASE}/custom_nodes/ComfyUI-Manager" ]; then
    cd "${COMFY_BASE}/custom_nodes" && git clone --depth 1 "$MANAGER_REPO"
fi

# 3. Install Python Dependencies
echo "üêç Installing Python Requirements..."
pip install --upgrade pip
cd "$COMFY_BASE" && pip install -r requirements.txt
pip install opencv-python imageio imageio-ffmpeg

# 4. DOWNLOAD WAN 2.2 (5B) MODELS - Optimized for RTX 4090
echo "üì• Downloading Wan 2.2 5B Models (Perfect for RTX 4090)..."
echo "   This will take 15-30 minutes depending on your connection"

# --- 4a. The Main 5B Diffusion Model (TI2V - Text+Image to Video) ---
# Size: ~10GB. Supports BOTH text-to-video AND image-to-video in one model!
# This is the 720p@24fps version optimized for consumer GPUs
URL_DIFF="https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/diffusion_models/wan2.2_ti2v_5B_fp16.safetensors"
download_file "$URL_DIFF" "${COMFY_BASE}/models/diffusion_models" "wan2.2_ti2v_5B_fp16.safetensors"

# --- 4b. Text Encoder (UMT5 XXL) ---
# Size: ~6GB (FP8 scaled). Same as Wan 2.1, required for understanding prompts.
URL_TEXT="https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/text_encoders/umt5_xxl_fp8_e4m3fn_scaled.safetensors"
download_file "$URL_TEXT" "${COMFY_BASE}/models/text_encoders" "umt5_xxl_fp8_e4m3fn_scaled.safetensors"

# --- 4c. Wan 2.2 VAE (NEW - Different from 2.1!) ---
# Size: ~1.4GB. Advanced Wan2.2-VAE with 16√ó16√ó4 compression ratio
URL_VAE="https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/vae/wan2.2_vae.safetensors"
download_file "$URL_VAE" "${COMFY_BASE}/models/vae" "wan2.2_vae.safetensors"

echo "---------------------------------------"
echo "‚úÖ Wan 2.2 (5B) Setup Complete!"
echo ""
echo "üìä MODEL SPECS:"
echo "   ‚Ä¢ Model: Wan 2.2 TI2V 5B (720p @ 24fps)"
echo "   ‚Ä¢ VRAM Required: ~12-16GB (Perfect for RTX 4090!)"
echo "   ‚Ä¢ Speed: <9 minutes for 5-second 720p video"
echo "   ‚Ä¢ Capabilities: Text-to-Video + Image-to-Video in ONE model"
echo ""
echo "üöÄ TO START COMFYUI:"
echo "   cd /workspace/ComfyUI"
echo "   python main.py --listen 0.0.0.0"
echo ""
echo "üí° USAGE TIPS:"
echo "   1. Update ComfyUI to latest version (Menu ‚Üí Manager ‚Üí Update)"
echo "   2. Load workflow: Menu ‚Üí Workflow Templates ‚Üí Video ‚Üí 'Wan2.2 5B'"
echo "   3. Or create custom workflow with these models:"
echo "      - Diffusion: wan2.2_ti2v_5B_fp16.safetensors"
echo "      - VAE: wan2.2_vae.safetensors"
echo "      - Text Encoder: umt5_xxl_fp8_e4m3fn_scaled.safetensors"
echo ""
echo "‚ö° WHY WAN 2.2 5B?"
echo "   ‚Ä¢ 2.5x faster than competing models"
echo "   ‚Ä¢ 720p native (vs 480p in Wan 2.1)"
echo "   ‚Ä¢ Better motion quality (+83% more training videos)"
echo "   ‚Ä¢ Cinematic aesthetics with precise control"
echo "   ‚Ä¢ ONE model for both T2V and I2V tasks"
echo ""
echo "üéØ RECOMMENDED SETTINGS FOR RTX 4090:"
echo "   ‚Ä¢ Resolution: 1280x704 or 704x1280 (720p)"
echo "   ‚Ä¢ Frames: 121 frames (5 seconds @ 24fps)"
echo "   ‚Ä¢ Enable model offloading if needed"
echo "---------------------------------------"
